<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prestação de Contas — Documentação financeira</title>
  <link rel="stylesheet" href="/styles/styles.css" />

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" integrity="sha384-+mbV2IY1Zk/X1p/nWllGySJSUN8uMs+gUAN10Or95UBH0fpj6GfKgPmgC5EXieXG" crossorigin="anonymous"></script>
</head>

<body class="layout-soft-bg docfin-page">
  <!-- Topbar -->
  <header class="header">
    <div class="header-logo">
      <img src="/assets/edge.png" alt="Edge" />
      <img src="/assets/vertex.png" alt="Vertex" style="margin-left:10px;height:40px;" />
    </div>
    <nav class="header-nav">
      <a href="/dashboard" class="nav-link">Painel de Projetos</a>
      <a href="/login" class="nav-link">Login</a>
    </nav>
  </header>

  <!-- Subnav -->
  <div class="subnav">
    <div class="subnav-inner">
      <div class="subnav-title">Prestação de Contas</div>
      <nav class="tabs">
        <a class="tab" id="tab-evidencias" href="#">Evidências</a>
        <a class="tab active" id="tab-docfin" href="#">Documentação financeira</a>
        <a class="tab" id="tab-bolsas" href="#">Gerenciamento de Bolsas</a>
      </nav>
    </div>
  </div>

  <main class="container container--wide">
    <section class="card block">
      <h1 class="block-title">Documentação financeira</h1>

      <!-- Cabeçalho do projeto -->
      <div class="project-head">
        <div><strong>Projeto:</strong> <span id="p-nome">—</span></div>
        <div><strong>Código:</strong> <span id="p-codigo">—</span></div>
        <div><strong>Gerente:</strong> <span id="p-gerente">—</span></div>
        <div><strong>Status:</strong> <span id="p-status">—</span></div>
      </div>

      <div class="divider"></div>

      <h3 class="block-subtitle">Cadastrar Compra</h3>

      <!-- ===== Form ===== -->
      <form id="form-evid" class="form-grid">
        <!-- Rubrica -->
        <label class="field span-2">
          <span>Tipo de rubrica</span>
          <select id="rubrica" required>
            <option value="Materiais de consumo">Materiais de consumo</option>
            <option value="Material para protótipo">Material para protótipo</option>
            <option value="Outros correlatos">Outros correlatos</option>
            <option value="Serviços técnicos de terceiros">Serviços técnicos de terceiros</option>
            <option value="Treinamento">Treinamento</option>
            <option value="Softwares / máquinas / equipamentos">
              Aquisição ou uso de programas de computação e aquisição de máquinas, de equipamentos, de aparelhos e de instrumentos, seus acessórios, sobressalentes e ferramentas
            </option>
            <option value="Infraestrutura PD&I">Aquisição, implantação, ampliação ou modernização de infraestrutura física e de laboratórios de PD&I</option>
            <option value="Livros e periódicos técnicos">Aquisições de livros e periódicos técnicos</option>
            <option value="Custos incorridos">Custos incorridos</option>
          </select>
        </label>

        <!-- CNPJ + Razão -->
        <label class="field">
          <span>CNPJ do favorecido</span>
          <input id="cnpj-fav" type="text" placeholder="00.000.000/0000-00" required />
          <small id="cnpj-hint" class="tiny muted"></small>
        </label>

        <label class="field">
          <span>Razão Social do Favorecido</span>
          <input id="fav-razao" type="text" placeholder="— detectado automaticamente —" readonly />
        </label>

        <!-- Comprovante -->
        <div class="field span-2">
          <label>Comprovante de Pagamento</label>
          <div id="pay-paste-zone" class="paste-zone">
            <p>
              <strong>Cole a imagem ou documento OFX aqui</strong> (Ctrl/Cmd+V), arraste/solte, ou
              <button type="button" class="link" id="btn-pay-upload">escolha um arquivo</button>.
            </p>
            <input id="payFileInput" type="file" class="hidden-file" accept="image/*,.ofx" />
            <img id="payPreview" alt="preview do comprovante" hidden />
            <div id="payStatus" class="muted"></div>
            <button id="btn-extrair-pagto" type="button" class="btn" disabled>Extrair dados</button>
          </div>
        </div>

        <!-- Campos extraídos do comprovante -->
        <div class="grid grid--4 span-2">
          <div class="field">
            <label for="inputDataPagamento">Data do pagamento</label>
            <input id="inputDataPagamento" type="text" placeholder="dd/mm/aaaa" />
          </div>
          <div class="field">
            <label for="inputNumeroExtrato">Nº do extrato</label>
            <input id="inputNumeroExtrato" type="text" />
          </div>
          <div class="field">
            <label for="inputValorPago">Valor pago (R$)</label>
            <input id="inputValorPago" type="text" value="0,00" />
          </div>
          <div class="field">
            <label for="inputMesAno">Mês/Ano</label>
            <input id="inputMesAno" type="text" placeholder="MM/AAAA" />
          </div>
        </div>

        <!-- Uploads (NF, Ofício, Ordem, Cotações) -->
        <div class="grid grid--2 span-2">
          <!-- NF -->
          <div class="field">
            <label>Nota Fiscal / Recibo (PDF/Imagem/OFX/XML)</label>
            <div class="upload-row">
              <input id="nfFileInput" class="hidden-file" type="file" accept="application/pdf,image/*,.ofx,.xml" />
              <button class="btn" type="button" data-pick="#nfFileInput">Enviar</button>
              <a id="md-nf-link" class="muted" hidden target="_blank" rel="noopener">abrir arquivo</a>
              <div id="hint-nf" class="muted"></div>
            </div>
          </div>

          <!-- Ofício -->
          <div class="field">
            <label>Ofício de Solicitação (PDF/Imagem)</label>
            <div class="upload-row">
              <input id="oficioFileInput" class="hidden-file" type="file" accept="application/pdf,image/*" />
              <button class="btn" type="button" data-pick="#oficioFileInput">Enviar</button>
              <a id="md-oficio-link" class="muted" hidden target="_blank" rel="noopener">abrir arquivo</a>
              <div id="hint-oficio" class="muted"></div>
            </div>
          </div>

          <!-- Ordem -->
          <div class="field">
            <label>Ordem de fornecimento (PDF/Imagem)</label>
            <div class="upload-row">
              <input id="ordemFileInput" class="hidden-file" type="file" accept="application/pdf,image/*" />
              <button class="btn" type="button" data-pick="#ordemFileInput">Enviar</button>
              <a id="md-ordem-link" class="muted" hidden target="_blank" rel="noopener">abrir arquivo</a>
            </div>
          </div>

          <!-- Cotações -->
          <div class="field">
            <label>Cotações (PDF/Imagem) — múltiplos</label>
            <div class="upload-row">
              <input id="cotacoesInput" class="hidden-file" type="file" multiple accept="application/pdf,image/*" />
              <button class="btn" type="button" data-pick="#cotacoesInput">Enviar</button>
              <ul id="cotacoesList" class="muted" hidden></ul>
            </div>
          </div>

        </div>

        <!-- ÚNICO botão "Adicionar à tabela" -->
        <div class="actions" style="grid-column:1 / -1; justify-content:flex-start; margin-top:12px">
          <button id="btn-add-row" class="btn btn--primary" type="submit">Adicionar à tabela</button>
        </div>
      </form>
      <!-- ===== /Form ===== -->
    </section>

    <!-- Tabela Processos de Compras -->
    <section class="card block" id="pc-section">
      <div class="block-title" style="display:flex;align-items:center;gap:12px;">
        <h2 style="margin:0;">Processos de compras</h2>
        <button id="btn-save" class="btn btn-primary" style="margin-left:auto;">Salvar tabela</button>
      </div>

      <div class="table-wrap">
        <table class="table" id="tbl-pc">
          <thead>
            <tr>
              <th>Favorecido</th>
              <th>Nº da PC</th>
              <th>CNPJ</th>
              <th>Data do título</th>
              <th>NF/Recibo</th>
              <th>Nº do extrato</th>
              <th>Data do pagamento</th>
              <th>Valor pago (R$)</th>
              <th>Tipo de rubrica</th>
              <th>Mês/Ano</th>
              <th>Justificativa para compra</th>
              <th>Documentação</th>
              <th style="width:84px">Ações</th>
            </tr>
          </thead>
          <tbody><!-- via JS --></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal Detalhes -->
  <dialog id="pc-modal" class="modal modal--xl">
    <div class="modal__content">
      <div class="modal__header">
        <h2>Detalhes do Processo de Compra</h2>
        <button type="button" class="icon-btn" id="pc-close" aria-label="Fechar">✕</button>
      </div>

      <div class="form-grid form-grid--pcmodal">
        <label class="field">
          <span>Favorecido</span>
          <input id="md-fav" type="text" readonly />
        </label>
        <label class="field">
          <span>CNPJ</span>
          <input id="md-cnpj" type="text" readonly />
        </label>

        <label class="field">
          <span>Nº da PC</span>
          <input id="md-pc" type="text" readonly />
        </label>
        <label class="field">
          <span>Data do título</span>
          <input id="md-data-titulo" type="text" readonly />
        </label>

        <label class="field">
          <span>Nº do recibo</span>
          <input id="md-nf" type="text" readonly />
        </label>
        <label class="field">
          <span>Nº do extrato</span>
          <input id="md-extrato" type="text" readonly />
        </label>

        <label class="field">
          <span>Data pagamento</span>
          <input id="md-data-pagto" type="text" readonly />
        </label>
        <label class="field">
          <span>Valor pago</span>
          <input id="md-valor" type="text" readonly />
        </label>

        <label class="field">
          <span>Tipo de rubrica</span>
          <select id="md-rubrica" disabled>
            <option value="">Selecione</option>
          </select>
        </label>
        <label class="field">
          <span>Mês/Ano</span>
          <input id="md-mesano" type="text" readonly />
        </label>

        <label class="field span-2">
          <span>Justificativa para compra</span>
          <textarea id="md-just" rows="3" readonly></textarea>
        </label>
      </div>

      <div class="divider"></div>

      <section>
        <h3 class="block-subtitle">Documentação enviada</h3>
        <div id="md-docs" class="muted tiny">Sem documentos anexados.</div>
      </section>

      <div class="divider"></div>

      <section>
        <h3 class="block-subtitle">Documentos assinados</h3>
        <div class="grid grid--2">
          <div class="field">
            <label>Folha de Rosto Assinada (PDF/Imagem)</label>
            <div class="upload-row">
              <input id="folhaAssinadaInput" class="hidden-file" type="file" accept="application/pdf,image/*" />
              <button class="btn" type="button" data-pick="#folhaAssinadaInput">Enviar</button>
              <a id="md-folha-ass-link" class="muted" hidden target="_blank" rel="noopener">abrir arquivo</a>
            </div>
            <div id="hint-folha-ass" class="muted tiny"></div>
          </div>

          <div class="field">
            <label>Mapa de Cotação Assinado</label>
            <div class="upload-row">
              <input id="decisaoAssinadaInput" class="hidden-file" type="file" accept="application/pdf,image/*" />
              <button class="btn" type="button" data-pick="#decisaoAssinadaInput">Enviar</button>
              <a id="md-decisao-ass-link" class="muted" hidden target="_blank" rel="noopener">abrir arquivo</a>
            </div>
            <small class="tiny muted">Aceita o Mapa de Cotação assinado ou a Justificativa para Dispensa assinada.</small>
          </div>
        </div>
      </section>

      <div class="modal__actions row" style="gap:12px;align-items:center;justify-content:flex-start;">
        <button type="button" class="btn btn-outline" id="pc-edit-details">Editar detalhamento</button>
        <button type="button" class="btn btn-primary" id="pc-save-details" hidden>Salvar detalhamento</button>
        <span id="pc-edit-feedback" class="tiny muted" role="status" aria-live="polite"></span>
      </div>

      <div class="divider"></div>

      <section>
        <h3 class="block-subtitle">Geração de Documentos</h3>
        <p class="tiny muted">Selecione abaixo o documento que deseja gerar ou baixe todos de uma vez.</p>

        <div class="row doc-actions" style="gap:12px;flex-wrap:wrap;">
          <button id="btn-folha" type="button" class="btn btn-action">Gerar Folha de Rosto</button>
          <button id="btn-mapa"  type="button" class="btn btn-action">Gerar Mapa de Cotação</button>
          <button id="btn-just"  type="button" class="btn btn-action">Gerar Justificativa para Dispensa</button>
          <button id="btn-zip"   type="button" class="btn btn-action">Baixar todos os documentos (ZIP)</button>
        </div>
      </section>
    </div>
  </dialog>

  <dialog id="zip-modal" class="modal">
    <div class="modal__content">
      <div class="modal__header">
        <h3>Selecionar documentos para download</h3>
        <button type="button" class="icon-btn" id="zip-close" aria-label="Fechar">✕</button>
      </div>

      <form id="zip-form" class="zip-form">
        <div id="zip-options" class="zip-options"></div>
        <p id="zip-empty" class="tiny muted" hidden>Nenhum documento disponível para este processo.</p>
        <p id="zip-feedback" class="tiny muted" role="status"></p>

        <div class="modal__footer">
          <button type="button" class="btn" id="zip-cancel">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="zip-confirm" disabled>Baixar ZIP</button>
        </div>
      </form>
    </div>
  </dialog>

  <div id="global-loading" class="loading-overlay" hidden aria-live="polite" aria-busy="false">
    <div class="loading-box" role="status">
      <span class="loading-spinner" aria-hidden="true"></span>
      <p id="global-loading-text">Processando…</p>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="/scripts.js"></script>
  <script type="module" src="/docfin.js"></script>
